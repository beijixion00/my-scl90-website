# SCL-90心理测评网站云服务器部署完整指南

## 🎯 部署概览

本指南将帮助您将SCL-90网站完全迁移到云服务器，实现：
- ✅ **低成本运营**：约80-100元/月
- ✅ **完全控制**：自主管理所有服务
- ✅ **高性能**：针对中国用户优化
- ✅ **可扩展**：支持多个测评网站

## 📋 云服务器选择对比

### 推荐配置方案

| 云服务商 | 配置 | 月费用 | 优势 | 购买链接 |
|---------|------|--------|------|----------|
| 阿里云ECS | 1核2G/40G/1M | 68元 | 国内访问快 | 阿里云官网 |
| 腾讯云CVM | 1核2G/50G/1M | 65元 | 价格最低 | 腾讯云官网 |
| 华为云ECS | 1核2G/40G/1M | 58元 | 企业级安全 | 华为云官网 |

### 最终推荐：阿里云ECS
```
推荐理由：
✅ 国内访问速度最快
✅ 技术文档完善
✅ 客服响应及时
✅ 生态系统成熟
✅ 符合数据合规要求
```

## 🚀 第一阶段：购买云服务器

### 步骤1：注册阿里云账户

1. **访问阿里云官网**
   - 网址：https://www.aliyun.com
   - 点击"免费注册"
   - 完成手机和邮箱验证

2. **实名认证**
   - 上传身份证照片
   - 完成人脸识别认证
   - 通常需要1-2小时审核

### 步骤2：购买ECS云服务器

1. **进入ECS购买页面**
   - 控制台 → 产品 → 弹性计算 → ECS云服务器

2. **选择配置**
   ```
   计费方式：包年包月（推荐）
   地域：华北2(北京) 或 华东1(杭州)
   实例规格：共享型 x86 架构
   实例规格族：ecs.s6-c1m1.small (1vCPU 1GB)
   操作系统：Ubuntu 20.04 64位
   存储：系统盘 40GB ESSD
   网络：专有网络VPC
   公网带宽：1Mbps
   购买时长：1年（最优惠）
   ```

3. **费用估算**
   ```
   服务器：68元/月 × 12 = 816元
   域名：约60元/年
   SSL证书：免费
   总计：约876元/年（平均73元/月）
   ```

### 步骤3：设置安全组

1. **开放必要端口**
   ```
   HTTP (80)：允许所有IP (0.0.0.0/0)
   HTTPS (443)：允许所有IP (0.0.0.0/0)
   SSH (22)：限制您的IP访问
   自定义 (3000)：允许所有IP (0.0.0.0/0)
   ```

2. **安全建议**
   - 不要开放3306(MySQL)到公网
   - 定期更新密码
   - 启用云盾防护

## 🔧 第二阶段：服务器基础配置

### 步骤1：连接服务器

1. **获取连接信息**
   - 在ECS控制台找到实例
   - 复制公网IP地址
   - 重置root密码

2. **使用SSH连接**
   ```bash
   # Windows用户使用PuTTY或CMD
   ssh root@您的服务器IP

   # Mac/Linux用户直接使用终端
   ssh root@您的服务器IP
   ```

### 步骤2：基础系统配置

1. **更新系统**
   ```bash
   # 更新软件包列表
   apt update

   # 升级系统
   apt upgrade -y

   # 安装必要工具
   apt install -y curl wget git vim htop
   ```

2. **创建用户账户**
   ```bash
   # 创建新用户
   adduser admin

   # 添加到sudo组
   usermod -aG sudo admin

   # 切换到新用户
   su - admin
   ```

3. **配置SSH密钥**
   ```bash
   # 在服务器上生成密钥
   ssh-keygen -t rsa -b 4096

   # 将公钥添加到授权文件
   mkdir -p ~/.ssh
   chmod 700 ~/.ssh
   echo "您的公钥内容" >> ~/.ssh/authorized_keys
   chmod 600 ~/.ssh/authorized_keys
   ```

## 🟢 第三阶段：Node.js环境配置

### 步骤1：安装Node.js

1. **使用NodeSource仓库**
   ```bash
   # 下载NodeSource安装脚本
   curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -

   # 安装Node.js 18
   sudo apt-get install -y nodejs

   # 验证安装
   node -v  # 应显示v18.x.x
   npm -v   # 应显示9.x.x
   ```

2. **配置npm**
   ```bash
   # 设置npm镜像源
   npm config set registry https://registry.npmmirror.com

   # 安装全局包管理器
   npm install -g pm2
   ```

### 步骤2：安装MongoDB

1. **导入MongoDB公钥**
   ```bash
   wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo apt-key add -
   ```

2. **添加MongoDB源**
   ```bash
   echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
   ```

3. **安装MongoDB**
   ```bash
   sudo apt-get update
   sudo apt-get install -y mongodb-org

   # 启动MongoDB服务
   sudo systemctl start mongod
   sudo systemctl enable mongod

   # 验证安装
   mongosh --eval 'db.runCommand({ connectionStatus: 1 })'
   ```

4. **配置MongoDB安全**
   ```bash
   # 连接MongoDB
   mongosh

   # 创建管理员用户
   use admin
   db.createUser({
     user: "admin",
     pwd: "您的管理员密码",
     roles: [ { role: "userAdminAnyDatabase", db: "admin" } ]
   })

   # 创建应用用户
   use scl90
   db.createUser({
     user: "scl90admin",
     pwd: "您的应用密码",
     roles: [ { role: "readWrite", db: "scl90" } ]
   })

   exit
   ```

### 步骤3：配置Nginx

1. **安装Nginx**
   ```bash
   sudo apt install -y nginx

   # 启动Nginx
   sudo systemctl start nginx
   sudo systemctl enable nginx

   # 验证安装
   sudo systemctl status nginx
   ```

2. **创建Nginx配置文件**
   ```bash
   sudo nano /etc/nginx/sites-available/scl90
   ```

3. **Nginx配置内容**
   ```nginx
   server {
       listen 80;
       server_name 您的域名.com www.您的域名.com;

       # 重定向到HTTPS
       return 301 https://$server_name$request_uri;
   }

   server {
       listen 443 ssl http2;
       server_name 您的域名.com www.您的域名.com;

       # SSL证书配置（稍后配置）
       # ssl_certificate /etc/ssl/certs/your-domain.crt;
       # ssl_certificate_key /etc/ssl/private/your-domain.key;

       # 安全配置
       ssl_protocols TLSv1.2 TLSv1.3;
       ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
       ssl_prefer_server_ciphers off;

       # 压缩配置
       gzip on;
       gzip_vary on;
       gzip_min_length 1024;
       gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

       # 静态文件配置
       location / {
           root /home/admin/scl90-website/public;
           try_files $uri $uri/ /index.html;

           # 缓存配置
           location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
               expires 1y;
               add_header Cache-Control "public, immutable";
           }
       }

       # API代理配置
       location /api {
           proxy_pass http://localhost:3000;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection 'upgrade';
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
           proxy_cache_bypass $http_upgrade;
       }

       # 管理员页面代理
       location /admin {
           proxy_pass http://localhost:3000;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection 'upgrade';
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
           proxy_cache_bypass $http_upgrade;
       }
   }
   ```

4. **启用配置**
   ```bash
   # 创建软链接
   sudo ln -s /etc/nginx/sites-available/scl90 /etc/nginx/sites-enabled/

   # 删除默认配置
   sudo rm /etc/nginx/sites-enabled/default

   # 测试配置
   sudo nginx -t

   # 重新加载Nginx
   sudo systemctl reload nginx
   ```

## 📁 第四阶段：应用部署

### 步骤1：克隆代码到服务器

1. **安装Git**
   ```bash
   sudo apt install -y git
   ```

2. **克隆项目**
   ```bash
   # 回到用户主目录
   cd ~

   # 克隆您的GitHub仓库
   git clone https://github.com/您的用户名/my-scl90-website.git

   # 进入项目目录
   cd scl90-website
   ```

3. **安装依赖**
   ```bash
   npm install
   ```

### 步骤2：配置环境变量

1. **创建生产环境配置**
   ```bash
   nano .env.production
   ```

2. **环境变量内容**
   ```env
   NODE_ENV=production
   PORT=3000
   MONGODB_URI=mongodb://scl90admin:您的应用密码@localhost:27017/scl90
   ADMIN_PASSWORD=1234love
   ```

### 步骤3：配置PM2进程管理

1. **创建PM2配置文件**
   ```bash
   nano ecosystem.config.js
   ```

2. **PM2配置内容**
   ```javascript
   module.exports = {
     apps: [{
       name: 'scl90-website',
       script: 'server-final.js',
       instances: 1,
       exec_mode: 'fork',
       env: {
         NODE_ENV: 'production',
         PORT: 3000
       },
       env_file: '.env.production',
       error_file: './logs/err.log',
       out_file: './logs/out.log',
       log_file: './logs/combined.log',
       time: true,
       autorestart: true,
       watch: false,
       max_memory_restart: '1G',
       node_args: '--max-old-space-size=1024'
     }]
   };
   ```

3. **创建日志目录**
   ```bash
   mkdir logs
   ```

4. **启动应用**
   ```bash
   # 启动应用
   pm2 start ecosystem.config.js

   # 查看状态
   pm2 status

   # 查看日志
   pm2 logs

   # 设置开机自启
   pm2 startup
   pm2 save
   ```

## 🔒 第五阶段：SSL证书配置

### 步骤1：安装Certbot

1. **安装Certbot**
   ```bash
   sudo apt install -y certbot python3-certbot-nginx
   ```

### 步骤2：获取SSL证书

1. **申请证书**
   ```bash
   # 替换为您的实际域名
   sudo certbot --nginx -d 您的域名.com -d www.您的域名.com
   ```

2. **配置自动续期**
   ```bash
   # 测试自动续期
   sudo certbot renew --dry-run

   # 添加自动续期任务
   sudo crontab -e

   # 添加以下行（每月1号凌晨3点检查）
   0 3 1 * * /usr/bin/certbot renew --quiet
   ```

## 🌐 第六阶段：域名配置

### 步骤1：购买域名

1. **推荐域名服务商**
   - 阿里云万网：https://wanwang.aliyun.com
   - 腾讯云：https://dnspod.cloud.tencent.com

2. **域名选择建议**
   ```
   专业域名：
   - scl90.cn
   - psych-test.cn
   - mental-assessment.cn
   - 心理测评.cn
   ```

### 步骤2：DNS解析配置

1. **添加A记录**
   ```
   主机记录: @
   记录类型: A
   记录值: 您的服务器IP
   TTL: 600
   ```

2. **添加www记录**
   ```
   主机记录: www
   记录类型: A
   记录值: 您的服务器IP
   TTL: 600
   ```

3. **等待DNS生效**
   - 通常需要10-30分钟
   - 使用`nslookup 您的域名.com`验证

## 📊 第七阶段：监控和维护

### 步骤1：配置系统监控

1. **安装监控工具**
   ```bash
   # 安装htop
   sudo apt install -y htop

   # 安装nethogs（网络监控）
   sudo apt install -y nethogs

   # 安装iotop（磁盘监控）
   sudo apt install -y iotop
   ```

2. **创建监控脚本**
   ```bash
   nano ~/monitor.sh
   ```

3. **监控脚本内容**
   ```bash
   #!/bin/bash

   # 系统监控脚本
   echo "=== 系统状态报告 $(date) ==="

   # CPU使用率
   echo "CPU使用率:"
   top -bn1 | grep "Cpu(s)" | awk '{print $2}' | awk -F'%' '{print $1}'

   # 内存使用情况
   echo "内存使用情况:"
   free -h

   # 磁盘使用情况
   echo "磁盘使用情况:"
   df -h

   # 网络连接数
   echo "网络连接数:"
   netstat -an | grep ESTABLISHED | wc -l

   # PM2应用状态
   echo "PM2应用状态:"
   pm2 status

   # MongoDB连接状态
   echo "MongoDB状态:"
   sudo systemctl is-active mongod

   echo "================================"
   ```

4. **设置定时监控**
   ```bash
   chmod +x ~/monitor.sh

   # 添加到crontab（每小时检查一次）
   crontab -e

   # 添加以下行
   0 * * * * ~/monitor.sh >> ~/monitor.log 2>&1
   ```

### 步骤2：配置日志轮转

1. **创建logrotate配置**
   ```bash
   sudo nano /etc/logrotate.d/scl90-website
   ```

2. **配置内容**
   ```
   /home/admin/scl90-website/logs/*.log {
       daily
       missingok
       rotate 7
       compress
       notifempty
       create 644 admin admin
       postrotate
           pm2 reloadLogs
       endscript
   }
   ```

## 🔧 第八阶段：备份和安全

### 步骤1：配置自动备份

1. **创建备份脚本**
   ```bash
   nano ~/backup.sh
   ```

2. **备份脚本内容**
   ```bash
   #!/bin/bash

   BACKUP_DIR="/home/admin/backups"
   DATE=$(date +%Y%m%d_%H%M%S)

   # 创建备份目录
   mkdir -p $BACKUP_DIR

   # 备份数据库
   mongodump --host localhost --port 27017 --db scl90 --out $BACKUP_DIR/mongodb_$DATE

   # 备份代码
   tar -czf $BACKUP_DIR/code_$DATE.tar.gz /home/admin/scl90-website

   # 备份配置文件
   tar -czf $BACKUP_DIR/config_$DATE.tar.gz /etc/nginx/sites-available/scl90 /home/admin/scl90-website/.env.production

   # 删除7天前的备份
   find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
   find $BACKUP_DIR -name "mongodb_*" -mtime +7 -exec rm -rf {} \;

   echo "备份完成: $DATE"
   ```

3. **设置自动备份**
   ```bash
   chmod +x ~/backup.sh

   # 添加到crontab（每天凌晨2点备份）
   crontab -e

   # 添加以下行
   0 2 * * * ~/backup.sh >> ~/backup.log 2>&1
   ```

### 步骤2：安全加固

1. **配置防火墙**
   ```bash
   # 安装UFW
   sudo apt install -y ufw

   # 默认策略
   sudo ufw default deny incoming
   sudo ufw default allow outgoing

   # 开放必要端口
   sudo ufw allow ssh
   sudo ufw allow 80/tcp
   sudo ufw allow 443/tcp

   # 启用防火墙
   sudo ufw enable
   ```

2. **配置fail2ban**
   ```bash
   # 安装fail2ban
   sudo apt install -y fail2ban

   # 创建配置文件
   sudo nano /etc/fail2ban/jail.local
   ```

3. **fail2ban配置**
   ```ini
   [DEFAULT]
   bantime = 3600
   findtime = 600
   maxretry = 3

   [sshd]
   enabled = true
   port = ssh

   [nginx-http-auth]
   enabled = true

   [nginx-limit-req]
   enabled = true
   ```

4. **启动fail2ban**
   ```bash
   sudo systemctl restart fail2ban
   sudo systemctl enable fail2ban
   ```

## 🧪 第九阶段：测试和验证

### 步骤1：功能测试清单

1. **基础功能测试**
   - [ ] 主页正常加载
   - [ ] 所有静态资源正常
   - [ ] HTTPS证书正常
   - [ ] API接口响应正常

2. **核心功能测试**
   - [ ] 管理员登录功能
   - [ ] 创建测评链接
   - [ ] 完成测评流程
   - [ ] 数据库读写正常

3. **性能测试**
   - [ ] 页面加载速度测试
   - [ ] API响应时间测试
   - [ ] 并发用户测试

### 步骤2：监控测试

1. **检查服务状态**
   ```bash
   # 检查Nginx
   sudo systemctl status nginx

   # 检查PM2
   pm2 status

   # 检查MongoDB
   sudo systemctl status mongod
   ```

2. **查看日志**
   ```bash
   # 查看应用日志
   pm2 logs

   # 查看Nginx日志
   sudo tail -f /var/log/nginx/access.log
   sudo tail -f /var/log/nginx/error.log

   # 查看系统日志
   sudo journalctl -f
   ```

## 📱 第十阶段：移动端和CDN配置

### 步骤1：移动端优化

1. **启用Nginx移动端优化**
   ```nginx
   # 在Nginx配置中添加
   location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|webp)$ {
       expires 1y;
       add_header Cache-Control "public, immutable";
       add_header Vary Accept-Encoding;

       # 移动端图片优化
       if ($http_accept ~* "webp") {
           rewrite (.+)\.(png|jpg|jpeg)$ $1.webp break;
       }
   }
   ```

### 步骤2：CDN配置（可选）

1. **阿里云CDN配置**
   - 登录阿里云CDN控制台
   - 添加加速域名
   - 配置源站IP
   - 开启HTTPS

## 🎯 部署成功验收标准

### 功能验收
- [ ] 网站通过HTTPS正常访问
- [ ] 所有功能正常运行
- [ ] 数据库读写正常
- [ ] 移动端显示正常

### 性能验收
- [ ] 页面加载时间 < 3秒
- [ ] API响应时间 < 500ms
- [ ] 服务器负载 < 50%
- [ ] 内存使用率 < 80%

### 安全验收
- [ ] SSL证书正常
- [ ] 防火墙配置正确
- [ ] 自动备份正常
- [ ] 监控系统正常

## 💰 成本总结

### 月度成本
```
云服务器：68元
域名费用：5元/月
总成本：约73元/月
```

### 年度成本
```
云服务器：816元（年付）
域名费用：60元/年
总成本：约876元/年
```

## 🆘 故障排除

### 常见问题

1. **网站无法访问**
   ```bash
   # 检查Nginx状态
   sudo systemctl status nginx

   # 检查端口占用
   sudo netstat -tlnp | grep :80

   # 查看Nginx日志
   sudo tail -f /var/log/nginx/error.log
   ```

2. **数据库连接失败**
   ```bash
   # 检查MongoDB状态
   sudo systemctl status mongod

   # 测试连接
   mongosh --host localhost --port 27017

   # 查看MongoDB日志
   sudo tail -f /var/log/mongodb/mongod.log
   ```

3. **应用无法启动**
   ```bash
   # 查看PM2状态
   pm2 status

   # 查看PM2日志
   pm2 logs

   # 重启应用
   pm2 restart all
   ```

## 🏆 总结

通过以上10个步骤，您将拥有：
- ✅ 完全自主的云服务器
- ✅ 高性能的SCL-90心理测评网站
- ✅ 专业的SSL证书配置
- ✅ 完善的监控和备份系统
- ✅ 月成本仅73元的高性价比方案

**部署完成后，您的网站将完全脱离Vercel限制，享受真正的独立运营！** 🎉

---

**预估部署时间：3-4小时**
**技术难度：中等**
**适合人群：有一定Linux基础的用户**